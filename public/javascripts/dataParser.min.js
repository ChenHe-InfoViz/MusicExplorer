function dataParser(t){function e(){if(S==T&&b==O&&j==C&&x==w){var t=!0,r=!1;0==B.length?(t=!1,a(),console.log("no top artists found")):(0==N.length||0==Object.keys(p).length)&&(t=!1,0==N.length&&(console.log("no artist-based recommendations"),i(B)),0==Object.keys(p).length&&(console.log("no tags!!"),c(B))),0==m.length&&(t=!1,console.log("no loved tracks recommendations."),u());var s=Object.keys(d);if(0==s.length?(t=!1,n()):s.length<5&&(t=!1,r=!0,$("#errorMessage").text("Sorry, you need at least 5 followings each of which needs at least 5 loved tracks at Last.fm to start this evaluation.")),t){var l=new Date;userBehavior.push({name:globalname,time:(l.getDate()<10?"0":"")+l.getDate()+" @ "+(l.getHours()<10?"0":"")+l.getHours()+":"+(l.getMinutes()<10?"0":"")+l.getMinutes()+":"+(l.getSeconds()<10?"0":"")+l.getSeconds()}),$("#dialog").dialog("close"),$("#login-header").text("Login as "+globalname),$("#login-header").off("click");var g=document.createElement("img");g.src="./javascripts/images/31.gif",document.getElementById("fader").appendChild(g),o()}else if(r)console.log("end"),Ui.prototype.signMark=1;else{var h=new Date;h-M>1e4?($("#errorMessage").text("Sorry, you don't have enough data to start this evaluation. You can\n* love more tracks at Last.fm.\n* add more friends at Last.fm (at least 5 followings).\n"),Ui.prototype.signMark=1):setTimeout(e,500)}}else{var h=new Date;h-M>1e4?($("#errorMessage").text("Sorry, you don't have enough data to start this evaluation. You can\n* love more tracks at Last.fm.\n* add more friends at Last.fm (at least 5 followings)."),Ui.prototype.signMark=1):setTimeout(e,500)}}function o(){m=m.unique(),f=f.concat(m),f=f.concat(N),f=f.concat(P);var e=0;for(var o in p)f=f.concat(p[o]);d[y]=v.currentUserBookmarks;for(var o in d)f=f.concat(d[o]);f=f.unique(),v.csvContent+="id;",P.length>0&&(v.csvContent+="most popular tracks ("+P.length+");",e++),m.length>0&&(v.csvContent+="lovedTrack-based agent ("+m.length+");",e++),N.length>0&&(v.csvContent+="yourArtists-based agent ("+N.length+");",e++);var n=e;v.JSONObject.name="Music Exploration",v.JSONObject.header=0,v.JSONObject.separator=";",v.JSONObject.skip=0,v.JSONObject.meta=[],v.JSONObject.meta.push({type:"id",index:0,name:"id"}),v.JSONObject.sets=[],v.JSONObject.sets.push({name:"Agents (number of tracks)",format:"binary",start:1,end:n}),e=n+1;for(var o in d){v.UserAndBookmarks.push({userName:o,setID:"",bookmarks:d[o]}),v.commonCount[o]=0;for(var r=0;r<d[o].length;r++)v.currentUserBookmarks.indexOf(d[o][r])>-1&&v.commonCount[o]++}for(var s=Object.keys(d).sort(function(t,e){return v.commonCount[e]==v.commonCount[t]?d[e].length-d[t].length:v.commonCount[e]-v.commonCount[t]}),a=0,c=s.length;c>a;++a)v.csvContent+=s[a]+" ("+v.commonCount[s[a]]+"/"+d[s[a]].length+");",n++;v.JSONObject.sets.push({name:"Friends (number of common tracks / number of total tracks)",format:"binary",start:e,end:n}),e=n+1;for(var o in p)v.csvContent+=o+" ("+p[o].length+");",n++;v.JSONObject.sets.push({name:"Tags (number of tracks)",format:"binary",start:e,end:n}),v.csvContent+="\n";for(var a=0;a<f.length;a++){var i=f[a];v.csvContent+=f[a]+";",P.length>0&&(P.indexOf(i)>-1?v.csvContent+="1;":v.csvContent+="0;"),m.length>0&&(m.indexOf(i)>-1?v.csvContent+="1;":v.csvContent+="0;"),N.length>0&&(N.indexOf(i)>-1?v.csvContent+="1;":v.csvContent+="0;");for(var l=0;l<s.length;l++)d[s[l]].indexOf(i)>-1?v.csvContent+="1;":v.csvContent+="0;";for(var o in p)p[o].indexOf(i)>-1?v.csvContent+="1;":v.csvContent+="0;";v.csvContent+="\n"}t()}function n(){$.ajax({type:"POST",url:k+"user.getfriends&user="+y,contentType:"json",success:function(t){try{r(t)}catch(e){console.log("friends error")}},error:function(){console.log("get friends list failed.")},timeout:5e3})}function r(t){var e=t.friends.user;C=e.length>50?50:e.length;for(var o=0;C>o;o++)$.ajax({type:"POST",url:k+"user.getlovedtracks&user="+e[o].name,contentType:"json",success:function(t){try{var e=t.lovedtracks.track;if(e.length>5){var o=this.url.split("=");d[o[o.length-1]]=new Array;for(var n=0;n<e.length;n++)e[n].mbid.length>0&&d[o[o.length-1]].push(e[n].mbid)}}catch(r){console.log("friend tracks error")}j++},error:function(){console.log("get friend tracks failed."),j++},timeout:5e3})}function s(t){t=t.unique(),O=t.length;for(var e=0;e<t.length;e++)$.ajax({type:"POST",url:k+"tag.getTopTracks&tag="+t[e],contentType:"json",success:function(t){try{var e=t.tracks.track,o=this.url.split("=");p[o[o.length-1]]=new Array;for(var n=0;n<e.length;n++)e[n].hasOwnProperty("mbid")&&e[n].mbid.length>0&&p[o[o.length-1]].push(e[n].mbid)}catch(r){console.log("tag tracks error")}b++},error:function(){this.url.split("=");console.log("get tag tracks list failed."),b++},timeout:5e3})}function a(){B=[],$.ajax({type:"POST",url:k+"user.gettopartists&user="+y,contentType:"json",success:function(t){try{for(var e=t.topartists.artist,o=0;o<e.length;o++)e[o].mbid.length>0&&B.push(e[o].mbid);i(B),c(B)}catch(n){console.log("top artists error")}},error:function(){console.log("get top artists list failed.")},timeout:5e3})}function c(t){for(var e=[],o=0,n=t.length>30?30:t.length,r=0;n>r;r++)$.ajax({type:"POST",url:k+"artist.gettoptags&mbid="+t[r],contentType:"json",success:function(t){try{for(var r=t.toptags.tag,a=0;a<r.length&&3>a;a++)e.push(r[a].name)}catch(c){console.log("artist tags error")}o++,o==n&&s(e)},error:function(){console.log("get artist tags list failed."),o++,o==n&&s(e)},timeout:5e3})}function i(t){var e,o=[],n=0;e=t.length>10?10:t.length;for(var r=0;e>r;r++)$.ajax({type:"POST",url:k+"artist.getsimilar&mbid="+t[r],contentType:"json",success:function(t){try{for(var r=t.similarartists.artist,s=0;s<r.length&&2>s;s++)r[s].hasOwnProperty("mbid")&&r[s].mbid.length>0&&o.push(r[s].mbid)}catch(a){console.log("similar artists error")}n++,n==e&&l(o)},error:function(){console.log("get similar artists list failed."),n++,n==e&&l(o)},timeout:5e3})}function l(t){w=t.length;for(var e=0;e<t.length;e++)$.ajax({type:"GET",url:k+"artist.gettoptracks&mbid="+t[e],contentType:"json",success:function(t){try{for(var e=t.toptracks.track,o=0;o<e.length&&5>o;o++)e[o].hasOwnProperty("mbid")&&e[o].mbid.length>0&&N.push(e[o].mbid)}catch(n){console.log("artist top tracks error"+n)}x++},error:function(){console.log("get artist top tracks list failed."),x++},timeout:5e3})}function g(){$.ajax({type:"GET",url:k+"geo.gettoptracks&country=united states",contentType:"json",success:function(t){try{for(var e=t.tracks.track,o=0;o<e.length&&100>o;o++)e[o].mbid.length>0&&P.push(e[o].mbid)}catch(n){console.log("track error")}},error:function(){console.log("get track list failed."),getToptracksByCountry()},timeout:5e3}).complete(J.resolve)}function u(){$.ajax({type:"GET",url:k+"user.getlovedtracks&user="+y,contentType:"json",success:function(t){try{for(var e=t.lovedtracks.track,o=[],n=0;n<e.length&&(e[n].mbid.length>0&&o.push(e[n].mbid),!(o.length>30));n++);h(o)}catch(r){console.log("track error"+r)}},error:function(){console.log("get track list failed.")},timeout:5e3})}function h(t){S=0;for(var e=0;e<t.length;e++)v.currentUserBookmarks.push(t[e]),30>e&&(S++,$.ajax({type:"POST",url:k+"track.getsimilar&mbid="+t[e],contentType:"json",success:function(t){try{for(var e=t.similartracks.track,o=0;o<e.length&&5>o;o++)e[o].hasOwnProperty("mbid")&&e[o].mbid.length>0&&m.push(e[o].mbid)}catch(n){console.log(n)}T++},error:function(){console.log("get similar tracks failed."),T++},timeout:3e3}))}this.JSONObject=new Object,this.csvContent="",this.currentUserBookmarks=[],this.UserAndBookmarks=[],this.commonCount={};var f=[],m=[],d={},p={},v=this;jQuery.support.cors=!0;var k="https://ws.audioscrobbler.com/2.0/?api_key=6e7a76f6e379cb31ed5f4f0022a130d4&format=json&method=",y=globalname,b=0,O=-1,j=0,C=-1,T=0,S=-1,x=0,w=-1,N=[],P=[],J=$.Deferred(),B=[];Array.prototype.unique=function(){var t,e={},o=this.length,n=[];for(t=0;o>t;t+=1)e[this[t]]=this[t];for(t in e)n.push(e[t]);return n},u(),a(),n(),g(),$.when(J).done(e());var M=new Date}