function plot(){ctx.plot()}function UpSet(){function t(){ctx.tableBodyHeight=renderRows.length*(ctx.cellDistance+4),ctx.rowScale=d3.scale.ordinal().rangeRoundBands([0,ctx.tableBodyHeight],0,0),ctx.rowScale.domain(renderRows.map(function(t){return t.id})),ctx.cellSize=ctx.cellDistance,ctx.xStartSetSizes=ctx.cellWidth*usedSets.length+ctx.majorPadding,ctx.setVisWidth=ctx.expectedValueWidth+ctx.subSetSizeWidth+ctx.majorPadding+ctx.xStartSetSizes,ctx.w=ctx.xStartSetSizes+ctx.subSetSizeWidth+ctx.expectedValueWidth+ctx.majorPadding+50,ctx.intersectionClicked=function(t){var e=Selection.fromSubset(t.data),a=[],r=[],n="",s="",i="",c="",l=0,o=t.data.elementName.split(","),d="normal";if(1==o.length&&"Query"==o[0])d="queryHeader",t.data.elements().forEach(function(t,e){var a=[];t.forEach(function(t){a.push({name:setIdToSet[t.key].elementName,type:setIdToSet[t.key].cluster,state:t.state})}),r.push(a)});else{var u=[];o.forEach(function(t){if(0==t)n="Tracks related to none of the selected sets.",u.push({name:null,type:null});else{var e=setIdToSet[t].elementName.split(/\(|\)/g);if(0==l){switch(setIdToSet[t].cluster){case 0:s=e[0].trim()+", ",n="Tracks recommended by "+s;break;case 1:i=e[0].trim()+", ",n="Tracks loved by "+i;break;case 2:c=e[0].trim()+", ",n="Tracks tagged with "+c}1==usedSets.length?(n=n.slice(0,-2),n+="."):n+="but not related to the rest of the selected sets.",l++}else{switch(setIdToSet[t].cluster){case 0:s+=e[0].trim()+", ";break;case 1:i+=e[0].trim()+", ";break;case 2:c+=e[0].trim()+", "}l++}u.push({name:setIdToSet[t].elementName,type:setIdToSet[t].cluster,state:1})}}),o.length>1&&(n="Tracks ",""!=s&&(n+="recommended by "+s),""!=i&&(n+="loved by "+i),""!=c&&(n+="tagged with "+c),usedSets.length>o.length?n+="but not related to the rest of the column(s).":(n=n.slice(0,-2),n+=".")),r.push(u)}e.items.forEach(function(t){a.push(attributes[0].values[t])});var p=new Date;userBehavior.push({type:4,setsCombination:r,group_type:t.type,query_header:d,Items:a.length,time:(p.getDate()<10?"0":"")+p.getDate()+" @ "+(p.getHours()<10?"0":"")+p.getHours()+":"+(p.getMinutes()<10?"0":"")+p.getMinutes()+":"+(p.getSeconds()<10?"0":"")+p.getSeconds()}),$(EventManager).trigger("user-behavior-added"),selections.addSelection(e,!1),selections.setActive(e),$("#element-view-description").text(n).css("color",selections.getColor(e))},"undefined"!=typeof ctx.svgBody&&(ctx.svgBody.attr("height",ctx.tableBodyHeight),ctx.svgBody.attr("width",ctx.w)),ctx.horizonBarGrays=d3.scale.linear().domain([0,1,2]).range(["#bdbdbd","#888888","#252525"])}function e(){var e=d3.scale.ordinal().domain([0,1]).range(ctx.grays);t(),d3.select("#bodyVis").select("svg").remove(),ctx.svgBody=d3.select("#bodyVis").append("svg").attr("width",ctx.w),ctx.columnBackgroundNode=ctx.svgBody.append("g").attr({"class":"columnBackgroundsGroup"}).attr({}),ctx.gRows=ctx.svgBody.append("g").attr({"class":"gRows"}),ctx.toolTipLayer=ctx.svgBody.append("g").attr({"class":"toolTipLayer"}),d3.select("#headerVis").select("svg").remove(),ctx.svgHeader=d3.select("#headerVis").append("svg").attr("width",ctx.w).attr("height",100+ctx.textHeight+ctx.guildHeaderHeight).attr("id","mysvg"),ctx.guildHeader=ctx.svgHeader.append("g").attr({"class":"guildHeader"}),ctx.guildHeader.append("circle").attr({r:ctx.cellSize/4-2,cy:ctx.cellSize/4,"class":"cell",transform:"translate(20,0)"}).style("fill",e(1)).style("stroke","#636363").attr({"stroke-width":"2pt"}),ctx.guildHeader.append("text").attr({"class":"cellGuild",transform:"translate(30,12)"}).text("Tracks recommended by the agent, loved by the user, or tagged with the tag."),ctx.guildHeader.append("circle").attr({r:ctx.cellSize/4-2,cy:ctx.cellSize/4,"class":"cell",transform:"translate(20,20)"}).style("fill",e(0)).style("stroke","#636363").attr({"stroke-width":"2pt"}),ctx.guildHeader.append("text").attr({"class":"cellGuild",transform:"translate(30,32)"}).text("Tracks not recommended by the agent, loved by the user, or tagged with the tag."),ctx.guildHeader.append("circle").attr({r:ctx.cellSize/4-2,cy:ctx.cellSize/4,"class":"cell",transform:"translate(20,40)"}).style("fill","#6fadfd").style("stroke","#6fadfd").attr({"stroke-width":"2pt"}),ctx.guildHeader.append("text").attr({"class":"cellGuild",transform:"translate(30,52)"}).text("Tracks loved by the current user."),ctx.tableHeaderNode=ctx.svgHeader.append("g").attr({"class":"tableHeader",transform:"translate("+ctx.leftOffset+","+ctx.guildHeaderHeight+")"}),c(),g(),initCallback=[a],h($(window).height(),null),h(null,$(".ui-layout-center").width())}function a(){ctx.svgBody.attr({width:Math.max(ctx.w,400)}),c(),g()}function r(t){t.selectAll("foreignObject").remove();var e=t.append("foreignObject").attr({transform:"translate("+(ctx.leftOffset+ctx.xStartSetSizes)+","+ctx.guildHeaderHeight+")",width:200,height:150}).append("xhtml:body").append("div").attr({id:"sortConfig","class":"configTable"});e.append("div").style("font-weight","bold").text("Sort rows by"),e.append("div").text("number of tracks");var a=e.append("div");a.append("input").attr({type:"radio",id:"sortIntersectionSizeAscend",name:"sort"});var r=a.append("label").attr({"for":"sortIntersectionSizeAscend"});r.append("img").attr({src:"./javascripts/images/ascend.png",width:15,height:15}),r.append("text").text("Ascending");var n=e.append("div");n.append("input").attr({type:"radio",id:"sortIntersectionSize",name:"sort"});var s=n.append("label").attr({"for":"sortIntersectionSize"});s.append("img").attr({src:"./javascripts/images/descend.png",width:15,height:15}),s.append("text").text("Descending"),e.append("div").text("number of filled circles");var i=e.append("div");i.append("input").attr({type:"radio",id:"sortNrSetsInIntersectionAscend",name:"sort"});var c=i.append("label").attr({"for":"sortNrSetsInIntersectionAscend"});c.append("img").attr({src:"./javascripts/images/ascend.png",width:15,height:15}),c.append("text").text("Ascending");var l=e.append("div");l.append("input").attr({type:"radio",id:"sortNrSetsInIntersectionDescend",name:"sort"});var o=l.append("label").attr({"for":"sortNrSetsInIntersectionDescend"});o.append("img").attr({src:"./javascripts/images/descend.png",width:15,height:15}),o.append("text").text("Descending"),""!=ctx.sortCheck&&d3.select("#"+ctx.sortCheck).attr("checked","true"),f()}function n(t){var e=d3.scale.ordinal().rangeRoundBands([0,usedSets.length*ctx.cellWidth],0);e.domain(usedSets.map(function(t){return t.id}));var a=t.selectAll(".setRow").data(usedSets,function(t){return t.elementName}),r=a.enter().append("g").attr({"class":"setRow"});a.exit().remove();var n=a.selectAll(".sortHeaderGroup").data(function(t,e){return[t]}),s=n.enter().append("g").attr({"class":"sortHeaderGroup"});s.append("text").text("").attr({"class":"groupDeleteIcon",transform:"translate(10, 15)"}).style("fill","#f46d43").on("click",setClicked).on("mouseover",function(t){document.getElementById("tipbar").innerHTML="Click to remove [ "+t.elementName+" ] from the view."}).on("mouseout",function(t){document.getElementById("tipbar").innerHTML=""}),s.append("rect").attr({transform:function(t,e){return"translate(0,15) skewX(-45)"},"class":"sortBySet connection vertical",width:ctx.cellWidth,height:ctx.textHeight-2}).on("mouseover",function(t,e){var a=t.elementName.split(/\(|\)/g),r="";switch(t.cluster){case 0:r+="recommended by "+a[0].trim();break;case 1:r+="bookmarked by "+a[0].trim();break;case 2:r+="tagged with "+a[0].trim()}document.getElementById("tipbar").innerHTML="Click to view all tracks "+r+".",mouseoverColumn(t,e)}).on("mouseout",function(t,e){document.getElementById("tipbar").innerHTML="",mouseoutColumn()}).append("svg:title").text(function(t,e){if(t.id==globalSetId)return"Tracks loved by you.";var a=t.elementName.split(/\(|\)|\//g);switch(t.cluster){case 0:return a[1].trim()+" tracks recommended by "+a[0].trim()+".";case 1:return parseInt(a[2].trim())>1?a[2].trim()+" tracks loved by "+a[0].trim()+".":a[2].trim()+" track loved by "+a[0].trim()+".";case 2:return parseInt(a[1].trim())>1?a[1].trim()+" tracks tagged with "+a[0].trim()+".":a[1].trim()+" track tagged with "+a[0].trim()+"."}return""}).style({"font-size":"16pt"});var i=(r.selectAll("text").data(function(t){return[t]}),r.append("text"));i.text(function(t){var e=t.elementName.substring(0,ctx.truncateAfter);return e.length<t.elementName.length&&(e=e.trim()+"..."),e}).attr({"class":"setLabel sortBySet noselect",id:function(t){return t.id},transform:"translate("+(-ctx.topOffset+90)+","+(ctx.leftOffset+10)+")rotate(-45)","text-anchor":"start"}).style({cursor:"s-resize"}).on("mouseover",function(t,e){var a=t.elementName.split(/\(|\)/g),r="";switch(t.cluster){case 0:r+="recommended by "+a[0].trim();break;case 1:r+="bookmarked by "+a[0].trim();break;case 2:r+="tagged with "+a[0].trim()}document.getElementById("tipbar").innerHTML="Click to view all tracks "+r+".",mouseoverColumn(t,e)}).on("mouseout",function(){document.getElementById("tipbar").innerHTML="",mouseoutColumn()}),i.append("svg:title").text(function(t,e){var a=setIdToSet[t.id].elementName.split(/\(|\)|\//g);switch(t.cluster){case 0:return a[1].trim()+" tracks recommended by "+a[0].trim()+".";case 1:return parseInt(a[2].trim())>1?a[2].trim()+" tracks loved by "+a[0].trim()+".":a[2].trim()+" track loved by "+a[0].trim()+".";case 2:return parseInt(a[1].trim())>1?a[1].trim()+" tracks tagged with "+a[0].trim()+".":a[1].trim()+" track tagged with "+a[0].trim()+"."}}).style({"font-size":"16pt"}),n.exit().remove(),a.attr({transform:function(t,a){return"translate("+e(t.id)+", 0)"},"class":"setRow"}),d3.selectAll(".sortBySet, .setRow .setLabel").on("click",function(t,e){var a=new Date;userBehavior.push({type:2,sort:[{name:t.elementName,type:t.cluster}],time:(a.getDate()<10?"0":"")+a.getDate()+" @ "+(a.getHours()<10?"0":"")+a.getHours()+":"+(a.getMinutes()<10?"0":"")+a.getMinutes()+":"+(a.getSeconds()<10?"0":"")+a.getSeconds()}),UpSetState.sorting=StateOpt.sortBySetItem,UpSetState.forceUpdate=!0,updateState(t),v(),$("#sortIntersectionSize").prop("checked",!1),$("#sortIntersectionSizeAscend").prop("checked",!1),$("#sortNrSetsInIntersectionAscend").prop("checked",!1),$("#sortNrSetsInIntersectionDescend").prop("checked",!1),ctx.sortCheck="";var r=Selection.fromSubset(levelOneGroups[parseInt(e/2)+1]),n=t.id,s=[];r.items.forEach(function(t){s.push(attributes[0].values[t])}),userBehavior.push({type:4,setsCombination:[{name:setIdToSet[n].elementName,type:setIdToSet[n].cluster,state:1}],group_type:t.type,Items:s.length,time:(a.getDate()<10?"0":"")+a.getDate()+" @ "+(a.getHours()<10?"0":"")+a.getHours()+":"+(a.getMinutes()<10?"0":"")+a.getMinutes()+":"+(a.getSeconds()<10?"0":"")+a.getSeconds()}),$(EventManager).trigger("user-behavior-added"),selections.addSelection(r,!1),selections.setActive(r);var i=setIdToSet[n].elementName.split(/\(|\)/g),c="";switch(setIdToSet[n].cluster){case 0:c+="recommended by "+i[0].trim();break;case 1:c+="bookmarked by "+i[0].trim();break;case 2:c+="tagged with "+i[0].trim()}$("#element-view-description").text("All tracks "+c+".").css("color",selections.getColor(r)),document.getElementById("tipbar").innerHTML="Showing all tracks "+c+" on the right side."}).style({cursor:"s-resize"})}function s(){}function c(){t(),$("#set-vis-container")[0].getBoundingClientRect().width-ctx.xStartSetSizes-45<450&&(ctx.subSetSizeWidth=$("#set-vis-container")[0].getBoundingClientRect().width-ctx.xStartSetSizes-45);var e=!1,a=ctx.svgHeader.selectAll(".tableHeaderGroup").data([1]),s=a.enter().append("g").attr({"class":"tableHeaderGroup noselect"});ctx.subSetSizeWidth<450&&null==s[0][0]&&(ctx.svgHeader.selectAll(".tableHeaderGroup").remove(),a=ctx.svgHeader.selectAll(".tableHeaderGroup").data([1]),s=a.enter().append("g").attr({"class":"tableHeaderGroup noselect"}),e=!0),r(ctx.svgHeader);var i=s.append("g").attr({id:"subSetSizeAxis","class":"axis"});i.each(function(){ctx.brushableScaleSubsetUpdate=function(){},ctx.brushableScaleSubset=new BrushableScale(ctx,d3.select(this),ctx.subSetSizeWidth,"brushableScaleSubsetUpdate","plotTable","subSetSizeScale",{columnLabel:"Number of tracks"})});var c=d3.max(ctx.globalStatistics,function(t){return t.value});a.selectAll("#subSetSizeAxis").attr({transform:"translate("+ctx.xStartSetSizes+","+(ctx.textHeight+5+ctx.guildHeaderHeight)+")"}).call(ctx.brushableScaleSubsetUpdate,{maxValue:c,labels:ctx.globalStatistics}),n(ctx.tableHeaderNode),ctx.subSetSizeWidth=$("#subSetSizeAxis")[0].getBoundingClientRect().width,ctx.svgHeader.attr("width",ctx.w)}function l(){var t=ctx.gRows.selectAll(".row").data(renderRows,function(t,e){return t.id}),e=t.enter().append("g").attr({transform:function(t){if(t.data.type===ROW_TYPE.SUBSET||t.data.type===ROW_TYPE.GROUP)return"translate(0, "+ctx.rowScale(t.id)+")";var e=ctx.textHeight;return 2==t.data.level&&(e+=10),"translate(0, "+e+")"},"class":function(t){return"row "+t.data.type}}).style("opacity",function(t){return t.data.type===ROW_TYPE.SUBSET||t.data.type===ROW_TYPE.GROUP?0==ctx.gRows.selectAll(".row")[0].length?1:0:ctx.gRows.selectAll(".row")[0].length?0:1}).on({mouseenter:function(t,e){var a=t.data.elementName.split(",");if(1==a.length)if(""==a[0])document.getElementById("tipbar").innerHTML="Click to view tracks related to none of the selected sets on the right side.";else{var r=setIdToSet[a[0]].elementName.split(/\(|\)/g);document.getElementById("tipbar").innerHTML="Click to view tracks only related to "+r[0].trim()+" on the right side."}else{var n=t.data.elementName.split(","),s="",i="",c="";n.forEach(function(t){var e=setIdToSet[t].elementName.split(/\(|\)/g);switch(setIdToSet[t].cluster){case 0:s+=e[0].trim()+", ";break;case 1:i+=e[0].trim()+", ";break;case 2:c+=e[0].trim()+", "}}),descriptionText="Click to view tracks ",""!=s&&(descriptionText+="recommended by "+s),""!=i&&(descriptionText+="loved by "+i),""!=c&&(descriptionText+="tagged with "+c),usedSets.length>n.length?descriptionText+="but not related to the rest of the column(s).":(descriptionText=descriptionText.slice(0,-2),descriptionText+="."),document.getElementById("tipbar").innerHTML=descriptionText}mouseoverRow(t,e)},mouseleave:function(t,e){document.getElementById("tipbar").innerHTML="",mouseoutRow(t)},click:function(t){(t.data.type===ROW_TYPE.SUBSET||t.data.type===ROW_TYPE.GROUP)&&d3.mouse(this)[0]>0&&d3.mouse(this)[0]<ctx.xStartSetSizes+ctx.subSetSizeWidth&&ctx.intersectionClicked(t)}});e.append("g").attr("class","gBackgroundRect"),e.append("g").attr("class","gHorizon"),e.append("g").attr("class","gOverlays"),e.append("g").attr("class","gIndicators"),t.exit().remove();var a=t;return ctx.rowTransitions&&usedSets.length<10&&(a=t.transition().duration(function(t,e){return t.data.type===ROW_TYPE.SUBSET?queryParameters.duration:queryParameters.duration})),a.attr({transform:function(t){return"translate(0, "+ctx.rowScale(t.id)+")"},"class":function(t){return"row "+t.data.type}}).transition().duration(100).style("opacity",1),t}function o(t,e){var a=t.select(".gBackgroundRect").selectAll(".backgroundRect").data(function(t){return[t]});a.enter().append("rect").attr({"class":"backgroundRect",x:0,y:0,width:ctx.setVisWidth,height:ctx.cellSize}).style({"fill-opacity":1e-4,fill:ctx.backHighlightColor}),a.exit().remove(),a.attr({width:ctx.setVisWidth,height:ctx.cellSize});var r=t.selectAll("g.combination").data(function(t){return[t.data.combinedSets]});r.enter().append("g").attr({"class":"combination"}),r.exit().remove();var n=r.selectAll(".cell").data(function(t){return t.map(function(t,e){return{data:usedSets[e],value:t}})});n.enter().append("circle").on({click:function(t){}}),n.exit().remove(),n.attr("cx",function(t,e){return ctx.cellWidth*e+ctx.cellWidth/2}).attr({r:ctx.cellSize/2-2,cy:ctx.cellSize/2,"class":"cell"}).style("fill",function(t){return 1==t.value&&t.data.id==globalSetId?"#6fadfd":e(t.value)}).style("stroke",function(t){return t.data.id==globalSetId?"#6fadfd":"#636363"}).attr({"stroke-width":"2pt"});r.selectAll(".cellConnector").data(function(t){var e=d3.extent(t.map(function(t,e){return 1==t?e:-1}).filter(function(t,e){return t>=0}));return e[0]==e[1]?[]:[e]});t.each(function(t,e){var a=d3.select(this),r=ctx.subSetSizeScale.domain()[1],n=0,s=1,i=d3.range(s).map(function(){var e={};return e.data={},e.data.type=t.data.type,1==s&&t.data.setSize>0&&t.data.setSize%r==0?(e.data.setSize=t.data.setSize,e):(n==s-1&&Math.ceil(t.data.setSize/r)<s+1?e.data.setSize=t.data.setSize%r:e.data.setSize=r,n++,e)});if(a.selectAll(".cutlines").remove(),Math.ceil(t.data.setSize/r)>ctx.maxLevels){var c=a.selectAll(".cutlines").data([t.id]).enter().append("g").attr("class","cutlines");c.append("line").attr({x1:ctx.xStartSetSizes+ctx.subSetSizeWidth-30,x2:ctx.xStartSetSizes+ctx.subSetSizeWidth-20,y1:0,y2:30}).style({stroke:"white","stroke-width":1}),c.append("line").attr({x1:ctx.xStartSetSizes+ctx.subSetSizeWidth-35,x2:ctx.xStartSetSizes+ctx.subSetSizeWidth-25,y1:0,y2:30}).style({stroke:"white","stroke-width":1})}var l=a.selectAll(".gHorizon").selectAll(".row-type-subset").data(i).enter();l.append("rect").attr("class",function(t){return"subSetSize row-type-subset"}),a.selectAll(".row-type-subset").data(i).exit().remove(),a.selectAll(".row-type-subset").attr({transform:function(t,e){var a=0;return t.data.type!==ROW_TYPE.SUBSET&&(a=0),"translate("+ctx.xStartSetSizes+", "+(a+ctx.cellSizeShrink*e+1)+")"},width:function(t,e){return ctx.subSetSizeScale(t.data.setSize)},height:function(t,e){return ctx.cellSize-2*ctx.cellSizeShrink*e-2}}).style({fill:function(t,e){return ctx.horizonBarGrays(e)}})})}function d(t){function e(){var e=t.filter(function(t){return"combinedSets"in t.data}),a=e.selectAll("g.combination").data(function(t){return[t.data.combinedSets]});a.enter().append("g").attr({"class":"combination"}),a.exit().remove();var r=a.selectAll(".cell").data(function(t){return t.map(function(t,e){return{data:usedSets[e],value:t}})});r.enter().append("circle"),r.exit().remove(),r.attr("cx",function(t,e){return ctx.cellWidth*e+ctx.cellWidth/2}).attr({r:ctx.cellSize/2-3,cy:ctx.cellSize/2,"class":"cell"}).style("fill",function(t){switch(t.value){case 0:return ctx.grays[0];case 1:return ctx.grays[1];default:return"url(#DontCarePattern)"}}).style({stroke:function(t){return 0==t.value?ctx.grays[1]:"none"}})}function a(){var e=t.filter(function(t){return"orClauses"in t.data&&t.data.orClauses.length>1}),a=e.selectAll("g.complexCombination").data(function(t){return[t.data.orClauses]});a.enter().append("g").attr({"class":"complexCombination"}),a.exit().remove(),a.selectAll("text").data(function(t){return[t]}).enter().append("text").attr({"class":function(){return ctx.cellDistance<14?"groupLabel small":"groupLabel"},x:usedSets.length*ctx.cellWidth*.5,y:ctx.cellWidth-3}).style({cursor:"pointer","text-anchor":"middle"}).text(function(t){return"combination"}).on({mouseover:function(t){var e=d3.select(this.parentNode.parentNode).attr("transform").split(/[,()]/);if(4==e.length){var a=ctx.toolTipLayer.append("g").attr({"class":"toolTipQuery",transform:"translate("+(+e[1]+ctx.leftOffset-5)+","+(+e[2]+ctx.cellSize+5)+")"});a.style({opacity:1e-5}).transition().style({opacity:1}),a.append("rect").attr({width:usedSets.length*ctx.cellWidth+10,height:t.length*ctx.cellSize+10,rx:10,ry:10}).style({"stroke-width":2,stroke:ctx.grays[1],fill:ctx.grays[0]}),t.forEach(function(t,e){var r=e*ctx.cellSize,n=a.append("g").attr({"class":"combination",transform:"translate(0,"+r+")"});n.selectAll(".cell").data(function(e){return Object.keys(t).map(function(e){return t[e]})}).enter().append("circle").attr("cx",function(t,e){return ctx.cellWidth*e+ctx.cellWidth/2+5}).attr({r:ctx.cellSize/2-3,cy:ctx.cellSize/2+5,"class":"cell"}).style("fill",function(t){switch(t.state){case 0:return ctx.grays[0];case 1:return ctx.grays[1];default:return"url(#DontCarePattern)"}}).style({stroke:function(t){return 0==t.value?ctx.grays[1]:"none"}})})}},mouseout:function(){ctx.toolTipLayer.selectAll(".toolTipQuery").transition().attr({opacity:1e-4}).remove()}})}var r=t.select(".gBackgroundRect").selectAll(".groupBackGround").data(function(t){return[t]});r.enter().append("rect").attr({"class":function(t){return t.data instanceof QueryGroup?"groupBackGround filterGroup":t.data.level>1?"groupBackGround secondLevel":"groupBackGround"},rx:5,ry:10,width:ctx.setVisWidth+ctx.leftOffset,height:ctx.cellSize,x:-ctx.leftOffset,y:0}),r.exit().remove(),r.attr({width:function(t){return ctx.setVisWidth+ctx.leftOffset-(t.data.level-1)*ctx.leftIndent},height:ctx.cellSize,x:function(t){return(t.data.level-1)*ctx.leftIndent-ctx.leftOffset}});var n=t.selectAll(".groupLabel.groupLabelText").data(function(t){return[t]});n.enter().append("text").attr({"class":"groupLabel groupLabelText",y:ctx.cellSize-3,x:function(t){return-ctx.leftOffset+12+(t.data.level-1)*ctx.leftIndent},"font-size":ctx.cellSize-6}),n.exit().remove();n.text(function(t){if(t.data.type===ROW_TYPE.AGGREGATE)return String.fromCharCode(8709)+"-subsets ("+t.data.subSets.length+") ";var e=0;e=t.data.type===ROW_TYPE.GROUP&&"undefined"!=typeof t.data.combinedSets?10:ctx.truncateGroupAfter;var a=t.data.elementName.substring(0,e);return a.length<t.data.elementName.length&&(a=a.trim()+"..."),a}).attr({"class":function(){return ctx.cellDistance<14?"groupLabel groupLabelText small":"groupLabel groupLabelText"},y:ctx.cellSize-3,x:function(t){return-ctx.leftOffset+15+(t.data.level-1)*ctx.leftIndent}}).on("click",function(t){UpSetState.forceUpdate=!0,collapseGroup(t.data),s(),v(!1)}).append("svg:title").text(function(t,e){return t.data.elementName}).style({"font-size":"16pt"});var i=t.selectAll(".collapseIcon").data(function(t){return[t]});i.enter().append("text").attr({"class":"collapseIcon"}).on("click",function(t){UpSetState.forceUpdate=!0,collapseGroup(t.data),s(),v(!1)}),i.text(function(t){return 0==t.data.isCollapsed?"":""}).attr({transform:function(t){return"translate("+(-ctx.leftOffset+2+5+(t.data.level-1)*ctx.leftIndent)+","+(ctx.cellSize/2+5)+")"}}).style({"font-size":"16pt"});var c=t.filter(function(t){return t.data instanceof QueryGroup}),l=c.selectAll(".groupDeleteIcon").data(function(t){return[t]}),o=l.enter().append("g").attr({"class":"groupDeleteIcon"});o.append("text").text("").on({click:function(t){var e=-1;UpSetState.logicGroups.forEach(function(a,r){a.id==t.id&&(e=r)}),UpSetState.logicGroups.splice(e,1),UpSetState.logicGroupChanged=!0,UpSetState.forceUpdate=!0,updateState(),v()}}).style({fill:"#f46d43"}),l.attr({transform:"translate("+(ctx.xStartSetSizes-12)+","+(ctx.cellSize/2+4)+")"}),e(),a(),t.each(function(t,e){var a=d3.select(this),r=ctx.subSetSizeScale.domain()[1],n=0,s=1,i=d3.range(s).map(function(){var e={};return e.data={},e.data.type=t.data.type,1==s&&t.data.setSize>0&&t.data.setSize%r==0?(e.data.setSize=t.data.setSize,e):(n==s-1&&Math.ceil(t.data.setSize/r)<s+1?e.data.setSize=t.data.setSize%r:e.data.setSize=r,n++,e)});if(a.selectAll(".cutlines").remove(),Math.ceil(t.data.setSize/r)>ctx.maxLevels){var c=a.selectAll(".cutlines").data([t.id]).enter().append("g").attr("class","cutlines");c.append("line").attr({x1:ctx.xStartSetSizes+ctx.subSetSizeWidth-30,x2:ctx.xStartSetSizes+ctx.subSetSizeWidth-20,y1:0,y2:30}).style({stroke:"white","stroke-width":1}),c.append("line").attr({x1:ctx.xStartSetSizes+ctx.subSetSizeWidth-35,x2:ctx.xStartSetSizes+ctx.subSetSizeWidth-25,y1:0,y2:30}).style({stroke:"white","stroke-width":1})}var l=a.select(".gHorizon").selectAll(".row-type-group").data(i).enter();l.append("rect").attr("class",function(t){return"subSetSize row-type-group"}),a.selectAll(".row-type-group").data(i).exit().remove(),a.selectAll(".row-type-group").attr({transform:function(t,e){return"translate("+ctx.xStartSetSizes+", "+(ctx.cellSizeShrink*e+2)+")"},width:function(t,e){return ctx.subSetSizeScale(t.data.setSize)},height:function(t,e){return ctx.cellSize-4-2*ctx.cellSizeShrink*e}}).style({fill:function(t,e){return ctx.horizonBarGrays(e)}}).on("click",function(t){})})}function u(t){if(0==selections.getSize())return t.selectAll(".what").remove(),t.selectAll(".newOverlay").remove(),void t.selectAll(".selectionIndicators").remove();var e=0;t.selectAll(".what").remove(),t.selectAll(".newOverlay").remove(),t.selectAll(".selectionIndicators").remove(),t.each(function(t,a){var r=d3.select(this),n=ctx.subSetSizeScale.domain()[1];t.data.type==ROW_TYPE.GROUP&&(t.data.selections={},t.data.selections.setSize=t.data.setSize,e=t.data.setSize,t.data.subSets.map(function(e,a){"undefined"==typeof t.data.selections&&(t.data.selections={});for(var r in e.selections)"undefined"==typeof t.data.selections[r]&&(t.data.selections[r]=[]),t.data.selections[r]=t.data.selections[r].concat(e.selections[r])}));var s=!1,i=Object.getOwnPropertyNames(t.data.selections),c=t.data.selections;if(i.forEach(function(t){c[t].length;selections.isActiveByUuid(t)&&(s=t)}),!s)return 0;e=c[s].length,t.data.type==ROW_TYPE.GROUP&&(t.data.selections.setSize=e);var l=0,o=1,d=d3.range(o).map(function(){var a={};return a.data={},a.data.setSize=e,a.data.type=t.data.type,1==o&&e>0&&e%n==0?(a.data.setSize=e,a):(l==o-1&&Math.ceil(e/n)<o+1?a.data.setSize=e%n:a.data.setSize=n,l++,a)}),u=r.selectAll(".gOverlays").selectAll(".newOverlay").data(d).enter();u.append("rect").attr("class","newOverlay"),r.selectAll(".newOverlay").data(d).exit().remove(),r.selectAll(".newOverlay").attr({transform:function(t,e){return"translate("+ctx.xStartSetSizes+", "+(ctx.cellSizeShrink*e+1)+")"},width:function(t,e){return ctx.subSetSizeScale(t.data.setSize)},height:function(t,e){return ctx.cellSize-2*ctx.cellSizeShrink*e-2},fill:function(e){var a=!1,r=Object.getOwnPropertyNames(t.data.selections),n=t.data.selections;return r.forEach(function(t){n[t].length;selections.isActiveByUuid(t)&&(a=t)}),a?selections.getColorFromUuid(a):0}}).style("opacity",function(t,e){return 1==o?1:2==o?.5+.2*e:.2+.3*e})})}function p(t){var e=t.selectAll(".intersectionSizeLabel").data(function(t){return[t]});e.enter().append("text").attr({"class":"intersectionSizeText intersectionSizeLabel noselect"}),e.exit().remove();var a=e.text(function(t){return t.data.setSize});ctx.barTransitions&&a.transition(),a.attr({"class":"intersectionSizeText intersectionSizeLabel noselect",y:ctx.cellSize/2,x:function(t){return ctx.xStartSetSizes+ctx.subSetSizeScale(t.data.setSize)+2}})}function S(){var t=ctx.columnBackgroundNode.selectAll(".columnBackground").data(usedSets);t.enter().append("rect").attr({"class":"columnBackground"}).style({stroke:"none",fill:ctx.backHighlightColor,opacity:0}),t.exit().remove(),t.attr({x:function(t,e){return ctx.cellWidth*e},height:ctx.svgHeight,width:ctx.cellWidth})}function g(){S();var t=null,e=l().filter(function(e){return e.data.type==ROW_TYPE.SEPARATOR?(t=d3.select(this),!1):!0}),a=d3.scale.ordinal().domain([0,1]).range(ctx.grays),r=e.filter(function(t){return t.data.type===ROW_TYPE.SUBSET});o(r,a);var n=e.filter(function(t,e){return t.data.type===ROW_TYPE.GROUP||t.data.type===ROW_TYPE.AGGREGATE?!0:!1});if(d(n),p(e),u(e),null!=t){var s=t.selectAll(".gSeparatorLine").data([1]);s.enter().append("line").attr({"class":"gSeparatorLine"}),s.attr({x1:-ctx.leftOffset,x2:ctx.w,y1:ctx.cellSize/2,y2:ctx.cellSize/2})}d3.selectAll(".setSizeBackground").each(function(t,e){t.elementName==ctx.newlyAddedSet&&(mouseoverColumn(t,e),ctx.newlyAddedSet="")}),d3.select(".divForeign").select("svg").attr("height",renderRows.length*ctx.cellDistance)}function m(){$(EventManager).bind("item-selection-added",function(t,e){e.selection.mapToSubsets(subSets),plotSelectionTabs("#selection-tabs",selections,e.selection),plotSelectedItems("#item-table",e.selection),elementViewers.renderViewer()}),$(EventManager).bind("item-selection-updated",function(t,e){e.selection.mapToSubsets(subSets),plot(),plotSelectionTabs("#selection-tabs",selections,e.selection),plotSelectedItems("#item-table",e.selection),elementViewers.renderViewer(),plotSetOverview()}),$(EventManager).bind("item-selection-activated",function(t,e){e.selection?(plot(),plotSelectionTabs("#selection-tabs",selections,e.selection),e.selection.filterCollection.renderFilters(),plotSelectedItems("#item-table",e.selection),plotSetOverview()):(plot(),plotSelectionTabs("#selection-tabs",selections,e.selection),plotSelectedItems("#item-table",e.selection)),elementViewers.renderViewer()}),$(EventManager).bind("loading-dataset-started",function(t,e){$(".ui-fader").show(),$("#data-loading-indicator").show()}),$(EventManager).bind("loading-dataset-finished",function(t,e){$(".ui-fader").fadeOut(1e3),$("#data-loading-indicator").fadeOut(1e3),elementViewers.renderController(),elementViewers.renderViewer()}),$(EventManager).bind("set-added",function(t,e){ctx.newlyAddedSet=e.set.elementName}),$(EventManager).bind("set-removed",function(t,e){}),$(EventManager).bind("refresh",function(t,e){var a=attributes[0].values[e];for(i=0;i<dataForVis.UserAndBookmarks.length;i++)if(dataForVis.UserAndBookmarks[i].bookmarks.indexOf(a)>-1){var r=dataForVis.UserAndBookmarks[i].setID,n=setIdToSet[r].elementName.split(/\(|\)|\//g);n[1]=++dataForVis.commonCount[dataForVis.UserAndBookmarks[i].userName];var s=" "+n[0].trim()+" ("+n[1]+"/"+n[2]+")";$('label[for="input'+r+'"]').text(s),0!=$('text[id="'+r+'"]').length&&d3.select("#"+r).text(s).append("svg:title").text(function(t,e){if(t.id==globalSetId)return"Tracks loved by you.";switch(t.cluster){case 1:return parseInt(n[2].trim())>1?n[2].trim()+" tracks loved by "+n[0].trim()+".":n[2].trim()+" track loved by "+n[0].trim()+"."}return""}),setIdToSet[r].elementName=s}var c=setIdToSet[globalSetId].elementName.split(/\(|\)|\//g),l=" "+c[0]+"("+parseInt(c[1],10)+"/"+(parseInt(c[2],10)+1)+")";d3.select("#"+globalSetId).text(l).append("svg:title").text("Tracks loved by you."),setIdToSet[globalSetId].itemList[e]=1,setIdToSet[globalSetId].elementName=l,setIdToSet[globalSetId].items.push(e),setIdToSet[globalSetId].setSize++,$('label[for="input'+globalSetId+'"]').text(l),x(),attributes[attributes.length-1].values[e].push(globalSetId),subSets.length=0,dataRows.length=0,setUpSubSets(),previousState=void 0,updateState(),plotSetOverview(),initCallback.forEach(function(t){t()})}),$(EventManager).bind("vis-svg-resize",function(t,e){h(null,e.newWidth),c(),g(),plotSetOverview()})}function x(){var t=$("ul#1>li");t.sort(function(t,e){var a=$("label",t).text().split(/\(|\)|\//g),r=$("label",e).text().split(/\(|\)|\//g);return parseInt(a[1])>parseInt(r[1])?-1:a[1]==r[1]&&parseInt(a[2])>parseInt(r[2])?-1:1}),$("ul#1").empty().html(t)}function f(){d3.selectAll("#sortNrSetsInIntersectionAscend").on("click",function(t){console.log("sssssssort"),ctx.sortCheck="sortNrSetsInIntersectionAscend",UpSetState.sorting=StateOpt.sortByCombinationSizeAscend;var e=new Date;userBehavior.push({type:2,sort:[{name:"sort by overlapping sizes Ascending",type:6}],time:(e.getDate()<10?"0":"")+e.getDate()+" @ "+(e.getHours()<10?"0":"")+e.getHours()+":"+(e.getMinutes()<10?"0":"")+e.getMinutes()+":"+(e.getSeconds()<10?"0":"")+e.getSeconds()}),UpSetState.forceUpdate=!0,updateState(),v(),document.getElementById("tipbar").innerHTML="Sort rows by the number of filled circles (ascending)."}),d3.selectAll("#sortNrSetsInIntersectionDescend").on("click",function(t){ctx.sortCheck="sortNrSetsInIntersectionDescend",UpSetState.sorting=StateOpt.sortByCombinationSizeDescend;var e=new Date;userBehavior.push({type:2,sort:[{name:"sort by overlapping sizes Descending",type:7}],time:(e.getDate()<10?"0":"")+e.getDate()+" @ "+(e.getHours()<10?"0":"")+e.getHours()+":"+(e.getMinutes()<10?"0":"")+e.getMinutes()+":"+(e.getSeconds()<10?"0":"")+e.getSeconds()}),UpSetState.forceUpdate=!0,updateState(),v(),document.getElementById("tipbar").innerHTML="Sort rows by the number of filled circles (descending)."}),d3.selectAll("#sortIntersectionSize").on("click",function(t){ctx.sortCheck="sortIntersectionSize",UpSetState.sorting=StateOpt.sortBySubSetSize;var e=new Date;userBehavior.push({type:2,sort:[{name:"sort by set sizes Descending",type:9}],time:(e.getDate()<10?"0":"")+e.getDate()+" @ "+(e.getHours()<10?"0":"")+e.getHours()+":"+(e.getMinutes()<10?"0":"")+e.getMinutes()+":"+(e.getSeconds()<10?"0":"")+e.getSeconds()
}),UpSetState.forceUpdate=!0,updateState(),v(),document.getElementById("tipbar").innerHTML="Sort rows by their related number of tracks (largest to smallest)."}),d3.selectAll("#sortIntersectionSizeAscend").on("click",function(t){ctx.sortCheck="sortIntersectionSizeAscend",UpSetState.sorting=StateOpt.sortBySubSetSizeAscend;var e=new Date;userBehavior.push({type:2,sort:[{name:"sort by set sizes Ascending",type:8}],time:(e.getDate()<10?"0":"")+e.getDate()+" @ "+(e.getHours()<10?"0":"")+e.getHours()+":"+(e.getMinutes()<10?"0":"")+e.getMinutes()+":"+(e.getSeconds()<10?"0":"")+e.getSeconds()}),UpSetState.forceUpdate=!0,updateState(),v(),document.getElementById("tipbar").innerHTML="Sort rows by their related number of tracks (smallest to largest)."})}function h(t,e){if(null==e);else if(null==t){ctx.svgBody.attr({width:Math.max(ctx.w,500)}),ctx.svgHeader.attr({});var a=ctx.cellWidth*usedSets.length+ctx.majorPadding+ctx.subSetSizeWidthMax+50;ctx.subSetSizeWidth=d3.scale.linear().domain([a,a-(ctx.subSetSizeWidthMax-100)]).range([ctx.subSetSizeWidthMax,100]).clamp(!0)(e),ctx.brushableScaleSubsetUpdate(null,{width:ctx.subSetSizeWidth})}}var v=function(t){null!=t?ctx.rowTransitions=t:ctx.rowTransitions=!0,c(),g(),ctx.rowTransitions=!0};ctx.updateColumnBackgrounds=S,ctx.plot=v,ctx.plotTable=function(){ctx.barTransitions=!1,g(),ctx.barTransitions=!0},initData(ctx,[e,m]),f()}var ctx={majorPadding:25,minorPadding:2,cellDistance:27,textHeight:130,textSpacing:25,setSizeWidth:700,subSetSizeWidth:450,subSetSizeWidthMax:450,leftOffset:130,leftIndent:10,topOffset:200,cellSizeShrink:3,maxLevels:1,expectedValueWidth:0,expectedValueWidthMax:0,labelTopPadding:42,paddingTop:30,paddingSide:20,truncateAfter:25,truncateGroupAfter:25,setCellDistance:12,setCellSize:10,cellWidth:27,svgHeight:1200,guildHeaderHeight:60,grays:["#f0f0f0","#636363"],backHighlightColor:"#fed9a6",specialHighlightColor:"#f4fd6f",rowTransitions:!0,barTransitions:!0,globalStatistics:[{name:"largest intersection",id:"I",value:100},{name:"largest aggregate",id:"A",value:120},{name:"largest set",id:"S",value:150},{name:"universal set",id:"U",value:400}],nameForRelevance:"Disproportionality",summaryStatisticVis:[{attribute:"",visObject:{}}],summaryStatisticsWidth:100,groupingOptions:{},setSelection:{paginationStart:0,paginationEnd:10,mode:"none",modeChange:!1,multiSelIn:d3.set(),multiSelOut:d3.set(),setOrder:"size"},logicStates:{NOT:0,DONTCARE:2,MUST:1},w:0,tableBodyHeight:0,rowScale:0,cellSize:0,xStartSetSizes:0,setVisWidth:0,xStartStatisticColumns:0,newlyAddedSet:"",scaleBarEndRange:100,sortCheck:"sortIntersectionSizeAscend"};